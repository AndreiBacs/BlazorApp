@page "/form"
@using BlazorApp.Data
@using System.Text
@using Microsoft.Extensions.Logging
@inject EmployeeService EmployeeService

<EditForm Model="@employee" OnValidSubmit="@HandleValidSubmit">
  <DataAnnotationsValidator />
  <ValidationSummary />
  <div>
    <p>
      <label>
        Name:
        <InputText id="name" @bind-Value="employee.FirstName" />
      </label>
    </p>
    <p>
      <label>
        Vorname:
        <InputText id="lastName" @bind-Value="employee.LastName" />
      </label>
    </p>
    <p>
      <label>
        Eintrittsdatum:
        <InputDate id="entryDate" @bind-Value="employee.EntryDate" />
      </label>
    </p>
    <p>
      <label>
        Abteilung:
        <InputText id="department" @bind-Value="employee.Department" />
      </label>
    </p>
    <p>
      <label>
        Aufgaben:
        <InputText disabled id="task" @bind-Value="employee.Tasks" />
      </label>
    </p>
    <p style="justify-content: space-evenly; display: flex;">
      <InputSelect @bind-Value="task">
        <option value=""></option>
        @foreach (var task in Tasks)
        {
          <option value="@task">@task</option>
        }
      </InputSelect>
      <button class="btn-primary" type="button" @onclick="(()=> AddOrRemoveTask())">Add</button>
      <button class="btn-info" type="button" @onclick="(()=> AddOrRemoveTask(true))">Remove</button>

    </p>
  </div>

  <div style="justify-content: space-evenly; display: flex;">
    <button class="btn-danger" type="button" @onclick="onCancel">Abbrechen</button>
    <button class="btn-success" type="submit">Speichem</button>
  </div>

</EditForm>

@code {
  [Parameter] public Employee employee { get; set; }

  [Parameter] public List<string> Tasks { get; set; }

  [Parameter] public EventCallback onSaveEmployee { get; set; }

  [Parameter] public EventCallback onCancel { get; set; }

  private static char delim = ',';

  string task = string.Empty;

  async void HandleValidSubmit()
  {
    EmployeeService.AddOrUpdateEmployee(employee);
    await onSaveEmployee.InvokeAsync();
  }

  public void AddOrRemoveTask(bool remove = false)
  {
    StringBuilder sb = new StringBuilder();
    var tasks = employee.Tasks.Split(delim).ToHashSet();
    if (remove)
    {
      tasks.Remove(task);
    }
    else
    {
      if (!string.IsNullOrWhiteSpace(task))
        tasks.Add(task);
    }

    tasks.ToList().ForEach(x =>
    {
      if (sb.Length > 0)
      {
        sb.Append(delim);
      }
      sb.Append(x);
    });

    employee.Tasks = sb.ToString();
  }
}